<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">

    <!-- D3/jquery/bootstrap -->
    <script src="https://d3js.org/d3.v5.min.js"
            integrity="sha384-M06Cb6r/Yrkprjr7ngOrJlzgekrkkdmGZDES/SUnkUpUol0/qjsaQWQfLzq0mcfg"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <!-- Common Functionalities Shared Among Pages -->
    <script src="js/common.js"></script>

    <!-- JavaScript for UntangleJS -->
    <script src="untangleJS/lib/DisjointSet.js"></script>
    <script src="untangleJS/lib/MaximalSpanningTree.js"></script>
    <script src="untangleJS/lib/JaccardWeights.js"></script>
    <script src="untangleJS/lib/NodeDegree.js"></script>
    <script src="untangleJS/lib/PriorityQueue.js"></script>
    <script src="untangleJS/SpanningTreeLayout.js"></script>
    <script src="untangleJS/SpanningTreeCycles.js"></script>
    <script src="untangleJS/LoopForce.js"></script>
    <script src="untangleJS/PH0D.js"></script>
    <script src="untangleJS/PH1D.js"></script>
    <script src="untangleJS/GraphDraw.js"></script>

    <title>Persistent Homology Makes Force-Directed Layouts Better</title>

</head>
<body>


<script>insert_navbar("index.html");</script>

<div class="page">

    <h1>Untangling Force-Directed Layouts with Persistent Homology</h1>
    <h2 style="margin-bottom: 40px">TopoInVis Submission #1000</h2>


        <div style="display: flex;">
            <div style="width: fit-content">
                <div style="width: fit-content">
                    <input type="range" min="0" max="100" value="0" width="200" class="slider" id="myRange" oninput="update_ph(this);">
                </div>
                <div style="width: fit-content">
                    <svg id="barcode" width=150 height=600></svg>
                </div>
                <div style="width: fit-content; margin: auto">
                    H<sub>0</sub> Features
                </div>
            </div>
            <div style="width: fit-content">
                <div style="width: fit-content; padding-top: 24px">
                    <svg id="barcode1d" width=150 height=600></svg>
                </div>
                <div style="width: fit-content; margin: auto">
                    H<sub>1</sub> Features
                </div>
            </div>
            <div>
                <svg id="graph" width=800 height=625></svg>
            </div>
            <div style="margin: 20pt; text-align: center">

                <p>Dataset</p>
                <select name="dataset" id="dataset" onchange="change_dataset()"></select>

                <hr>
                <p>Initial Layout</p>
                <div style="margin: 5pt"><input type="button" id="btn-random" class="btn btn-primary" value="Random Layout (conventional)" onclick="reset_graph('random')"/></div>
                <div style="margin: 5pt"><input type="button" id="btn-radial_layout"  class="btn btn-outline-primary" value="Radial Layout (our approach)" onclick="reset_graph('radial_layout')"/></div>
                <div style="margin: 5pt"><input type="button" id="btn-layered_layout" class="btn btn-outline-primary" value="Layered Layout (our approach)" onclick="reset_graph('layered_layout')"/></div>
                <hr>
                <p>Color Nodes By...</p>
                <div class="form-check" style="margin: auto; width: 120px">
                    <input class="form-check-input" type="radio" name="color_by" id="color_by_group" onclick="update_colors()">
                    <label class="form-check-label" for="color_by_group">Group</label>
                </div>
                <div class="form-check" style="margin: auto; width: 120px">
                    <input class="form-check-input" type="radio" name="color_by" id="color_by_degree_ranked" onclick="update_colors()" checked>
                    <label class="form-check-label" for="color_by_degree_ranked">Degree</label>
                </div>
            </div>
        </div>
    </div>
</body>


<script>

let graph = null
let ph0d = null
let ph1d = null
let graphDraw = null
let stlayout = null


function change_dataset(){

    let cur_dataset = dataset[ document.getElementById('dataset').value ]
    console.log( cur_dataset )

    let start_time = performance.now()
    d3.json(cur_dataset)
        .then(_graph => {
            graph = _graph;

            let end_time = performance.now()
            console.log( "Data Download/Parse: " + (end_time - start_time) + " ms")

            console.log( graph.nodes.length + " nodes; " + graph.links.length + " links" )

            document.getElementById('myRange').value = 0
            d3.select("#barcode").selectAll("*").remove();
            d3.select("#barcode1d").selectAll("*").remove();

            // For graphs without weights
            start_time = performance.now()
            let weightRange = d3.extent( graph.links, l=> ('value' in l) ? l.value : 1 )
            if( weightRange[1] - weightRange[0] === 0)
                calculate_jaccard_weights(graph)
            calculate_node_degree(graph)
            end_time = performance.now()
            console.log( "Weight Calculation (Jaccard): " + (end_time - start_time) + " ms")

            start_time = performance.now()
            stlayout = SpanningTreeLayout(graph)
            end_time = performance.now()
            console.log( "Spanning Tree Calculation: " + (end_time - start_time) + " ms")

            start_time = performance.now()
            ph0d = PersistentHomology0D("#barcode", graph, stlayout.spanning_tree())
            end_time = performance.now()
            console.log( "PH0D Calculation: " + (end_time - start_time) + " ms")

            start_time = performance.now()
            ph1d = PersistentHomology1D("#barcode1d", graph, stlayout.spanning_tree())
            end_time = performance.now()
            console.log( "PH1D Calculation: " + (end_time - start_time) + " ms")

            reset_graph()
        });
}


function update_colors(){
    update_graph_draw_colors(graphDraw,
                             document.getElementById('color_by_group').checked,
                             false, //document.getElementById('color_by_degree').checked,
                             document.getElementById('color_by_degree_ranked').checked )
}

function reset_graph( layout_method="random"){
    d3.select("#graph").selectAll("*").remove();
    d3.select("#convergence").selectAll("*").remove();
    d3.select("#dist_pres").selectAll("*").remove();
    layouts.forEach( l => {
        document.getElementById("btn-"+l).setAttribute("class", "btn " + ( l === layout_method ? "btn-primary": "btn-outline-primary" ) )
    })

    // Clear any existing node positions
    graph.nodes.forEach(n=>{
      delete n.x
      delete n.y
    })

    // Initialize Layout
    let start_time = performance.now()
    if( layout_method !== 'random'){
        if( layout_method === 'radial_layout') stlayout.radial_layout([5,795],[5,595])
        if( layout_method === 'layered_layout') stlayout.layered_layout([5,795],[5,595])
    }
    let end_time = performance.now()
    console.log( "Layout Time ("+layout_method+"): " + (end_time - start_time) + " ms")

    // Draw Graph
    start_time = performance.now()
    graphDraw = GraphDraw(graph).set_tick_callback( ()=>{ } )
                                 .set_click_callback( (d)=>console.log(d) )

    update_colors()
    end_time = performance.now()
    console.log( "Initialize FDL Time: " + (end_time - start_time) + " ms")

    if( ph0d ) ph0d.set_graph_draw(graphDraw)
    if( ph1d ) ph1d.set_graph_draw(graphDraw)

}

function update_ph(slider){
    ph0d.update_threshold(slider.value)
}

let html = "";
dataset.forEach( function(d,i){
    if( d === 'data/bn-mouse-visual-cortex-2.json')
        html += '<option value="'+ i +'" selected>'+ d +'</option>';
    else
        html += '<option value="'+ i +'">'+ d +'</option>';
});
document.getElementById('dataset').innerHTML = html

change_dataset();


</script>
</html>
